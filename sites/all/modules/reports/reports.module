<?php

/**
 * @return mixed
 */
function reports_menu() {
  $items['training-center/reports'] = array(
    'title' => 'Отчеты по дистанционному обучению',
    'page callback' => 'reports_main_page',
    'access arguments' => array('administer training'),
    'type' => MENU_CALLBACK,
  );
  // Отчет по подпискам и завершению курсов за период
  $items['reports/signup'] = array(
    'title' => 'Отчет по подпискам и завершению курсов за период',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('reports_signup_form'),
    'access arguments' => array('administer training'),
    'type' => MENU_CALLBACK,
  );

  return $items;
}

function reports_main_page() {
  $output = l('Отчет по подпискам и завершению курсов за период', 'reports/signup');

  return $output;
}

/**
 * @param $form
 * @param $form_state
 * @return mixed
 */
function reports_signup_form($form, &$form_state) {

  $format = 'Y-m-d';

  if (isset($_GET['start_date'])) {
    $start_date = $_GET['start_date'];
  } else {
    $start_date = time();
  }

  if (isset($_GET['end_date'])) {
    $end_date = $_GET['end_date'];
  } else {
    $end_date = time();
  }

  $form = array();

  $form['start_date'] = array(
    '#type' => 'date_popup',
    // types 'date_text' and 'date_timezone' are also supported. See .inc file.
    '#title' => t('Start date'),
    '#default_value' => date($format, $start_date),
    '#date_format' => $format,
    '#date_label_position' => 'within',
    // See other available attributes and what they do in date_api_elements.inc
    '#date_increment' => 15,
    // Optional, used by the date_select and date_popup elements to increment minutes and seconds.
    '#date_year_range' => '-3:+3',
    // Optional, used to set the year range (back 3 years and forward 3 years is the default).
    '#datepicker_options' => array(),
    // Optional, as of 7.x-2.6+, used to pass in additional parameters from the jQuery Datepicker widget.
  );

  $form['end_date'] = array(
    '#type' => 'date_popup',
    // types 'date_text' and 'date_timezone' are also supported. See .inc file.
    '#title' => t('End date'),
    '#default_value' => date($format, $end_date),
    '#date_format' => $format,
    '#date_label_position' => 'within',
    // See other available attributes and what they do in date_api_elements.inc
    '#date_increment' => 15,
    // Optional, used by the date_select and date_popup elements to increment minutes and seconds.
    '#date_year_range' => '-3:+3',
    // Optional, used to set the year range (back 3 years and forward 3 years is the default).
    '#datepicker_options' => array(),
    // Optional, as of 7.x-2.6+, used to pass in additional parameters from the jQuery Datepicker widget.
  );

  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => t('Сформировать отчет'),
  );

  if (isset($_GET['start_date'])) {
    $form['table'] = array(
      '#markup' => reports_result($start_date, $end_date),
    );
  }

  return $form;
}

/**
 * @param $form
 * @param $form_state
 * @return string
 */
function reports_signup_form_submit($form, &$form_state) {
  $start_date = strtotime($form_state['values']['start_date']);
  $end_date = strtotime($form_state['values']['end_date']);

  $form_state['redirect'] = array(
    'reports/signup',
    array(
      'query' => array(
        'start_date' => $start_date,
        'end_date' => $end_date,
      ),
    ),
  );
}

/**
 * Функция формирует отчет и выводит его.
 * @param $start_date
 * @param $end_date
 * @return string
 */
function reports_result($start_date, $end_date) {
  $courses = reports_signup_courses($start_date, $end_date);
  if($courses) {
    $first_lessons = reports_get_first_lessons($courses);
    $result = reports_get_results($first_lessons, $start_date, $end_date);

    return reports_signup_output($result, $start_date, $end_date);
  } else {
    return '<div id="no-results">Нет результатов за период c ' . date('d.m.Y', $start_date) . ' по ' . date('d.m.Y', $end_date) . '</div>';
  }

}

/**
 * Функция получает массив из уникальных id курсов, на которые были подписаны пользователи за указанный период $date - $date2.
 * На выходе массив из id курсов.
 * @param $start_date
 * @param $end_date
 * @return string
 */
function reports_signup_courses($start_date, $end_date) {
  $flag_signup = flag_get_flag('signup');

  $query = db_select('flag_content', 'f');
  $query->join('field_data_field_course2', 'fc', 'f.content_id = fc.entity_id');
  $db_and = db_and();
  $db_and->condition('f.timestamp', array($start_date, $end_date), 'BETWEEN');
  $db_and->condition('f.fid', $flag_signup->fid);
  $query->condition($db_and);
  $query->distinct();
  $query->addField('fc', 'field_course2_target_id', 'course_id');
  $result = $query->execute()->fetchAll();

  if ($result) {
    foreach ($result as $item) {
      $courses[] = $item->course_id;
    }
    return $courses;
  } else {
    return FALSE;
  }


}

/**
 * Функция ищет id первого урока для указанных курсов
 * @param $courses
 * @return string
 */
function reports_get_first_lessons($courses) {

  foreach ($courses as $course_id) {
    $query = db_select('node', 'n');
    $query->join('field_data_field_course2', 'fc', 'fc.entity_id = n.nid');
    $query->condition('fc.field_course2_target_id', $course_id);
    $query->orderBy('n.title');
    $query->range(0, 1);
    $query->fields('n', array('nid'));
    $lessons[] = $query->execute()->fetchField();
  }

  return $lessons;
}

/**
 * Функция делает выборку по подписанным материалам с условиями.
 * @param $first_lessons
 * @param $start_date
 * @param $end_date
 * @return string
 */
function reports_get_results($first_lessons, $start_date, $end_date) {
  // Флаг подписки
  $flag_signup = flag_get_flag('signup');

  $query = db_select('flag_content', 'f');
  // Пользователи отметившие
  $query->join('users', 'u', 'f.uid = u.uid');
  // Получаем ФИО
  $query->join('field_data_field_user_full_name', 'ufn', 'ufn.entity_id = u.uid');
  // Должность
  $query->join('field_data_field_user_position', 'up', 'up.entity_id = u.uid');
  // Офис
  $query->join('field_data_field_user_office', 'uo', 'uo.entity_id = u.uid');
  // id курса
  $query->join('field_data_field_course2', 'fc', 'fc.entity_id = f.content_id');
  // Название блока
  $query->join('field_data_field_block', 'fb', 'fb.entity_id = fc.field_course2_target_id');
  $query->join('node', 'nb', 'nb.nid = fb.field_block_target_id');
  // Название курса
  $query->join('node', 'n', 'fc.field_course2_target_id = n.nid');
  // Отдел
  $query->join('field_data_group_audience', 'ga', 'ga.entity_id = u.uid');
  $query->join('og', 'o', 'o.gid = ga.group_audience_gid');
  // Условия
  $db_and = db_and();
  $db_and->condition('f.content_id', $first_lessons, 'IN');
  $db_and->condition('f.fid', $flag_signup->fid);
  $db_and->condition('f.timestamp', array($start_date, $end_date), 'BETWEEN');
  $query->condition($db_and);
  // Поля
  $query->addField('nb', 'title', 'block_name');
  $query->addField('n', 'title', 'course_name');
  $query->addField('fc', 'field_course2_target_id', 'course_id');
  $query->addField('u', 'uid',  'uid');
  $query->addField('ufn', 'field_user_full_name_value', 'fullname');
  $query->addField('up', 'field_user_position_value', 'position');
  $query->addField('o', 'label', 'department');
  $query->addField('uo', 'field_user_office_value', 'office');
  $query->addField('f', 'timestamp', 'signup_time');

  $results = $query->execute()->fetchAll();

  foreach($results as $key => $row) {
    $results[$key]->evaluate = reports_course_evaluate($row->course_id, $row->uid);
  }

  return $results;
}

/**
 * Функция проверяет, завершен ли курс
 * @param $course_id
 * @param $uid
 * @return bool|string
 */
function reports_course_evaluate($course_id, $uid) {
  // Получаем id последнего урока для указанного курса
  $query = db_select('node', 'n');
  $query->join('field_data_field_course2', 'fc', 'fc.entity_id = n.nid');
  $query->condition('fc.field_course2_target_id', $course_id);
  $query->fields('n', array('nid'));
  $count = $query->countQuery()->execute()->fetchField();
  $query->range($count - 1, $count);
  $last_lesson_id = $query->execute()->fetchField();
  // Находим все результаты теста для последнего урока
  $query2 = db_select('node', 'n');
  $query2->join('field_data_field_lesson', 'fl', 'n.nid = fl.field_lesson_target_id');
  $query2->join('node', 'n2', 'fl.entity_id = n2.nid');
  $query2->join('quiz_node_results', 'qnr', 'n2.nid = qnr.nid');
  $query2->condition('n.nid', $last_lesson_id);
  $query2->condition('qnr.uid', $uid);
  $query2->fields('qnr');
  $count2 = $query->countQuery()->execute()->fetchField();
  $query->range($count2 - 1, $count2);
  $quiz_result = $query2->execute()->fetchObject();

  // Если есть результаты
  if ($quiz_result) {
    $quiz_nid = $quiz_result->nid;
    $quiz_vid = $quiz_result->vid;
    // Сдан ли данный тест
    $is_passed_quiz = quiz_is_passed($uid, $quiz_nid, $quiz_vid);
    if($is_passed_quiz == TRUE) {
      return date('d.m.Y', $quiz_result->time_end);
    }
  } else {
    return 'Не завершен';
  }
}

/**
 * @param $data
 * @param $start_date
 * @param $end_date
 * @return string
 */
function reports_signup_output($data, $start_date, $end_date) {

  //Дальше создаем таблицу и выводим полученные данные
  // Создаем   заголовок таблицы
  $caption = t('Отчет по подпискам и завершению курсов за период с ' . date('d.m.Y', $start_date) . ' по ' . date('d.m.Y', $end_date));
  // Создаем заголовки столбцов
  $header = array(
    array(
      'data' => t('№'),
    ),
    array(
      'data' => t('Название блока'),
    ),
    array(
      'data' => t('Название курса'),
    ),
    array(
      'data' => t('ФИО пользователя'),
    ),
    array(
      'data' => t('Должность'),
    ),
    array(
      'data' => t('Отдел'),
    ),
    array(
      'data' => t('Офис'),
    ),
    array(
      'data' => t('Дата подписки'),
    ),
    array(
      'data' => t('Дата завершения курса'),
    ),
  );

  foreach ($data as $key => $item) {
    $rows[] = array(
      array(
        'data' => $key + 1,
      ),
      array(
        'data' => $item->block_name,
      ),
      array(
        'data' => $item->course_name,
      ),
      array(
        'data' => $item->fullname,
      ),
      array(
        'data' => $item->position,
      ),
      array(
        'data' => $item->department,
      ),
      array(
        'data' => $item->office,
      ),
      array(
        'data' => date('d.m.Y', $item->signup_time),
      ),
      array(
        'data' => $item->evaluate,
      ),
    );
  }

  //dpm($rows);

  $output = theme('table', array(
      // Шапка таблицы
      'header' => $header,
      // Тело таблицы
      'rows' => $rows,
      // Заголовок таблицы
      'caption' => $caption,
      // Атрибуты таблицы
      'attributes' => array('width' => '100%'),
    )
  );

  return $output;
}